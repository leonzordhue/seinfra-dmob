<!--
SEINFRA/AM - DMOB - INTERFACE WEB COMPLETA
Com ABA DE RODOVIAS funcionando!
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEINFRA/AM - DMOB - Consulta Ramais/Rodovias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .ramal-card { 
            transition: transform 0.2s; 
            cursor: pointer; 
            margin-bottom: 15px;
            border-left: 4px solid #dee2e6;
        }
        .ramal-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .navbar-brand { font-weight: bold; }
        .loading { 
            text-align: center; 
            padding: 20px; 
            color: #6c757d; 
        }
        .nav-tabs .nav-link.active {
            font-weight: 600;
            background-color: #fff;
            border-bottom-color: #fff;
        }
        .cadastro-ramal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .tab-content {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 20px;
        }
        .badge-contrato {
            font-size: 0.75em;
            background-color: #17a2b8;
        }
        .rodovia-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-road me-2"></i>SEINFRA/AM - DMOB
            </a>
            <div class="navbar-text text-white">
                <small>Departamento de Mobilidade - Consulta Ramais/Rodovias</small>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- üÜï ABAS PRINCIPAIS - NOVA ABA DE RODOVIAS ADICIONADA -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ramais-tab" data-bs-toggle="tab" data-bs-target="#ramais" type="button" role="tab">
                    <i class="fas fa-map-marked-alt me-2"></i>Consulta de Ramais
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rodovias-tab" data-bs-toggle="tab" data-bs-target="#rodovias" type="button" role="tab">
                    <i class="fas fa-route me-2"></i>Consulta de Rodovias
                </button>
            </li>
        </ul>

        <!-- CONTE√öDO DAS ABAS -->
        <div class="tab-content" id="mainTabsContent">
            
            <!-- ABA RAMAIS (MANTIDA INTACTA) -->
            <div class="tab-pane fade show active" id="ramais" role="tabpanel">
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-search me-2"></i>Consulta de Ramais por Munic√≠pio
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Selecione o Munic√≠pio:</label>
                            <select id="selectMunicipio" class="form-select">
                                <option value="">Carregando munic√≠pios...</option>
                            </select>
                        </div>
                        
                        <div id="listaRamais" class="mt-3" style="display: none;">
                            <h6 class="border-bottom pb-2">Ramais encontrados:</h6>
                            <div id="ramaisContainer" class="loading">
                                <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                            </div>
                            
                            <div class="card cadastro-ramal mt-4" id="cardCadastroRamal" style="display: none;">
                                <div class="card-body text-center">
                                    <h6><i class="fas fa-plus-circle me-2"></i>N√£o Encontrou seu Ramal?</h6>
                                    <p class="mb-3">Solicite o Cadastro do seu Ramal</p>
                                    <button class="btn btn-light btn-sm" onclick="abrirCadastroRamal()">
                                        <i class="fas fa-edit me-1"></i>Cadastrar Novo Ramal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üÜï ABA RODOVIAS - NOVA! -->
            <div class="tab-pane fade" id="rodovias" role="tabpanel">
                <div class="card shadow-sm mt-3">
                    <div class="card-header rodovia-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>Consulta de Rodovias Estaduais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Selecione a Rodovia:</label>
                            <select id="selectRodovia" class="form-select">
                                <option value="">Carregando rodovias...</option>
                            </select>
                        </div>
                        
                        <div id="detalhesRodovia" style="display: none;">
                            <div id="rodoviaInfo" class="loading">
                                <i class="fas fa-spinner fa-spin me-2"></i>Carregando detalhes da rodovia...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAIS (mantidos os existentes) -->
        <div class="modal fade" id="modalRamal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Detalhes do Ramal</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalRamalBody">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin me-2"></i>Carregando detalhes...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mantenha os outros modais existentes (Solicita√ß√£o e Cadastro) -->
    </div>

    <footer class="bg-light mt-5 py-3">
        <div class="container text-center">
            <small class="text-muted">
                Secretaria de Infraestrutura do Amazonas - Departamento de Mobilidade (DMOB)
            </small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // =============================================================================
    // INICIALIZA√á√ÉO DO SISTEMA
    // =============================================================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log("üöÄ Sistema SEINFRA/AM inicializado");
        carregarMunicipios();
        carregarRodovias(); // üÜï CARREGA RODOVIAS NA INICIALIZA√á√ÉO
        configurarEventListeners();
    });

    // =============================================================================
    // FUN√á√ïES DOS RAMAIS (MANTIDAS INTACTAS - N√ÉO ALTERAR!)
    // =============================================================================
    function carregarMunicipios() {
        fetch('/api/municipios')
            .then(response => response.json())
            .then(municipios => {
                const select = document.getElementById('selectMunicipio');
                select.innerHTML = '<option value="">Selecione um munic√≠pio</option>';
                
                municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.textContent = municipio.nome;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    const municipioId = this.value;
                    if (municipioId) {
                        carregarRamaisPorMunicipio(municipioId);
                    } else {
                        document.getElementById('listaRamais').style.display = 'none';
                    }
                });
            })
            .catch(error => {
                document.getElementById('selectMunicipio').innerHTML = 
                    '<option value="">Erro ao carregar munic√≠pios</option>';
            });
    }

    function carregarRamaisPorMunicipio(municipioId) {
        const container = document.getElementById('ramaisContainer');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i>Carregando ramais...</div>';
        document.getElementById('listaRamais').style.display = 'block';
        
        fetch(`/api/ramais/${municipioId}`)
            .then(response => response.json())
            .then(ramais => {
                container.innerHTML = '';
                
                if (ramais.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Nenhum ramal encontrado para este munic√≠pio.</div>';
                    document.getElementById('cardCadastroRamal').style.display = 'block';
                    return;
                }
                
                document.getElementById('cardCadastroRamal').style.display = 'block';
                
                ramais.forEach(ramal => {
                    const card = document.createElement('div');
                    card.className = 'card mb-3 ramal-card';
                    
                    const temObraIcon = ramal.tem_obra ? 
                        '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Sim</span>' : 
                        '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> N√£o</span>';
                    
                    const contratoInfo = ramal.numero_contrato ? 
                        `<br><small><strong>CT/CV:</strong> <span class="badge bg-info">${ramal.numero_contrato}</span></small>` : 
                        '';
                    
                    card.innerHTML = `
                        <div class="card-body">
                            <h6 class="card-title">${ramal.descricao}</h6>
                            <p class="card-text mb-2">
                                <small><strong>Extens√£o:</strong> ${ramal.extensao_km} km</small><br>
                                <small><strong>Tem Obra?:</strong> ${temObraIcon}</small>
                                ${contratoInfo}
                            </p>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="verDetalhesRamal(${ramal.id})">
                                    <i class="fas fa-info-circle me-1"></i>Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            })
            .catch(error => {
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar ramais.</div>';
            });
    }

    function verDetalhesRamal(ramalId) {
        const modalBody = document.getElementById('modalRamalBody');
        modalBody.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i>Carregando detalhes...</div>';
        
        fetch(`/api/ramal/${ramalId}`)
            .then(response => response.json())
            .then(ramal => {
                const contratoBadge = ramal.numero_contrato ? 
                    `<span class="badge badge-contrato ms-2"><i class="fas fa-file-contract me-1"></i>CT/CV: ${ramal.numero_contrato}</span>` : 
                    '';
                
                modalBody.innerHTML = `
                    <h6 class="text-primary mb-3">${ramal.descricao}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Munic√≠pio:</strong> ${ramal.municipio_nome}</p>
                            <p><strong>Extens√£o:</strong> ${ramal.extensao_km} km</p>
                            <p><strong>Rodovia de Acesso:</strong> ${ramal.rodovia_acesso || 'N√£o informada'}</p>
                            <p><strong>Tem Obra?:</strong> 
                                ${ramal.tem_obra ? 
                                    '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Sim</span>' : 
                                    '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i> N√£o</span>'}
                                ${contratoBadge}
                            </p>
                            <p><strong>Revestimento:</strong> ${ramal.revestimento || 'N√£o informado'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Local de In√≠cio:</strong> ${ramal.local_inicio || 'N√£o informado'}</p>
                            <p><strong>Local de T√©rmino:</strong> ${ramal.local_termino || 'N√£o informado'}</p>
                            <p><strong>Ano de Conclus√£o:</strong> ${ramal.ano_conclusao || 'N√£o informado'}</p>
                            <p><strong>Classifica√ß√£o:</strong> ${ramal.classificacao || 'N√£o informada'}</p>
                            <p><strong>Segmenta√ß√£o:</strong> ${ramal.segmentacao || 'N√£o informada'}</p>
                        </div>
                    </div>
                    
                    ${ramal.ponto_referencia ? `<p><strong>Ponto de Refer√™ncia:</strong> ${ramal.ponto_referencia}</p>` : ''}
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-primary btn-lg" onclick="abrirSolicitacao(${ramal.id})">
                            <i class="fas fa-edit me-2"></i> Fazer Solicita√ß√£o
                        </button>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('modalRamal'));
                modal.show();
            })
            .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes do ramal.</div>';
            });
    }

    // =============================================================================
    // üÜï FUN√á√ïES DAS RODOVIAS - NOVAS!
    // =============================================================================
    function carregarRodovias() {
        console.log("üõ£Ô∏è Carregando lista de rodovias...");
        
        fetch('/api/rodovias')
            .then(response => {
                console.log("Resposta da API /api/rodovias:", response.status);
                return response.json();
            })
            .then(rodovias => {
                console.log(`‚úÖ ${rodovias.length} rodovias carregadas`);
                
                const select = document.getElementById('selectRodovia');
                select.innerHTML = '<option value="">Selecione uma rodovia</option>';
                
                rodovias.forEach(rodovia => {
                    const option = document.createElement('option');
                    option.value = rodovia.rodovia;
                    option.textContent = rodovia.rodovia;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    const rodoviaNome = this.value;
                    console.log(`üéØ Rodovia selecionada: ${rodoviaNome}`);
                    if (rodoviaNome) {
                        carregarDetalhesRodovia(rodoviaNome);
                    } else {
                        document.getElementById('detalhesRodovia').style.display = 'none';
                    }
                });
            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar rodovias:', error);
                document.getElementById('selectRodovia').innerHTML = 
                    '<option value="">Erro ao carregar rodovias</option>';
            });
    }

    function carregarDetalhesRodovia(nomeRodovia) {
        console.log(`üîç Buscando detalhes da rodovia: ${nomeRodovia}`);
        
        const container = document.getElementById('rodoviaInfo');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i>Carregando detalhes da rodovia...</div>';
        document.getElementById('detalhesRodovia').style.display = 'block';
        
        fetch(`/api/rodovia/${encodeURIComponent(nomeRodovia)}`)
            .then(response => response.json())
            .then(rodovia => {
                console.log("üìä Dados da rodovia recebidos:", rodovia);
                
                if (rodovia.error) {
                    container.innerHTML = `<div class="alert alert-danger">${rodovia.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-route me-2"></i>${rodovia.rodovia}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Extens√£o Total:</strong> ${rodovia.extensao_total}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Total de Trechos:</strong> ${rodovia.total_trechos}</p>
                                </div>
                            </div>
                            
                            <h6 class="border-bottom pb-2">Trechos da Rodovia:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Extens√£o</th>
                                            <th>In√≠cio</th>
                                            <th>Final</th>
                                            <th>Revestimento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                rodovia.trechos.forEach(trecho => {
                    html += `
                        <tr>
                            <td>${trecho.codigo_ser_snv || '-'}</td>
                            <td>${trecho.extensao || '-'}</td>
                            <td>${trecho.inicio || '-'}</td>
                            <td>${trecho.final || '-'}</td>
                            <td>${trecho.tipo_revestimento || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                console.log("‚úÖ Detalhes da rodovia carregados!");
            })
            .catch(error => {
                console.error('‚ùå Erro ao carregar detalhes da rodovia:', error);
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar dados da rodovia.</div>';
            });
    }

    // =============================================================================
    // FUN√á√ïES AUXILIARES (MANTIDAS)
    // =============================================================================
    function configurarEventListeners() {
        document.getElementById('tipoServico').addEventListener('change', function() {
            document.getElementById('divOutros').style.display = 
                this.value === 'outros' ? 'block' : 'none';
        });

        document.getElementById('tipoServicoCadastro').addEventListener('change', function() {
            document.getElementById('divOutrosCadastro').style.display = 
                this.value === 'outros' ? 'block' : 'none';
        });
    }

    // Mantenha as outras fun√ß√µes existentes
    </script>
</body>
</html>